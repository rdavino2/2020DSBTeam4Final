---
title: "Team 4 Final Project"
author: "Rocco Davino, Tung Nguyen, Sungwoo Nam"
date: "Last updated on `r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: kable
---

<!--
Comments in HTML are like this! 
-->

```{r setup, include=FALSE}
library(tidyverse)
library(MASS)
library(broom)
library(modelr)
```

```{r wrangling, message=FALSE, results='hide'}
nbadata <- read_csv(file = "NBAData.csv")
# Convert position to factor
nbadata$Position <- factor(nbadata$Position)
# Convert team to factor
nbadata$Team <- factor(nbadata$Team)
# Make column with Salary as dbl
nbadata <- nbadata %>%
  mutate(Salary_dbl = str_sub(Salary,2))
nbadata$Salary_dbl <- as.numeric(gsub(",", "", nbadata$Salary_dbl))/1000000
# Rename Length of Contract
nbadata <- nbadata %>%
  rename(LOC = `Length of Contract`)
# Make LOC factor?
```

First, we visualize some contract data.

```{r}
# LOC histogram
nbadata %>%
  ggplot() +
  geom_bar(aes(x = LOC)) +
  xlab("Length of Contract") + ylab("Count")
# LOC histogram with proportion
nbadata %>%
  ggplot() +
  geom_bar(aes(x = LOC,fill = Position), position = "fill") +
  xlab("Length of Contract") + ylab("Count")
```

The 6-year contract is rare, while 2 to 5-year contracts are all common. The 6-year contracts seem to be disproportionately given to centers, which is an interesting phenomenon. How does length of contract affect salary?

```{r}
# Boxplot
nbadata %>%
  ggplot() +
  geom_boxplot(aes(x = LOC, y = Salary_dbl, group = LOC)) +
  xlab("Length of Contract") + ylab("Salary (millions USD)")
```

Which teams have the largest average salary?

```{r}
# Bar chart
nbadata %>%
  group_by(Team) %>%
  summarise(AvgSal=mean(Salary_dbl)) %>%
  arrange(desc(AvgSal)) %>%
  slice(1:5) %>%
  ggplot() +
    geom_bar(aes(x = Team, y = AvgSal, fill = Team), stat = "identity") +   # Look up how to avoid overlap 
    ylab("Average Salary")
```

Lastly, does age have an effect on PER? At which age is PER the largest?

```{r}
# Scatter plot
nbadata %>%
  ggplot() + 
    geom_point(aes(x = Age, y = PER))
# Density plot
nbadata %>%
  filter(PER > 20) %>%
  ggplot() +
    geom_density(aes(x = Age)) +
    ylab("Density")
```

How about 2P, the average numer of shots made inside the 3-point line per game? To help answer this, we use linear modeling.

```{r}
# Scatter plot
nbadata %>%
  ggplot(aes(x = `2P`, y = Salary_dbl)) +
    geom_point(aes(color = Position)) + 
    ylab("Salary (millions USD)") + xlab("2P (avg. # shots made from inside 3-point/game)")
# Model 2 by position 
nbadata0 <- nbadata %>%
  group_by(Position) %>%
  #filter(Position %in% c("Forward","Guard")) %>%
  nest()
# Functions for regression frame
fit_model <- function (df) lm(Salary_dbl ~ `2P`, data = df)
fit_model_aug <- function (df) lm(Salary_dbl ~ `2P`, data = df) %>% augment()
get_rsq <- function (mod) glance(mod)$r.squared
# Create tidy regression frame
nbadata0 <- nbadata0 %>%
  mutate(model = map(data, fit_model))
nbadata0 <- nbadata0 %>%
  mutate(aug = map(data, fit_model_aug))
nbadata0 <- nbadata0 %>%
  mutate(r.sqradj = map_dbl(model, get_rsq))    # Get R^2
# Plot the regression by position
unnest(nbadata0, aug) %>%
  ggplot() + 
    geom_line(aes(x = `X2P`, y = .fitted, color = Position)) +
    geom_point(aes(x = `X2P`, y = Salary_dbl, color = Position)) + 
    xlab("2P (avg. # shots made from inside 3-point/game)") + ylab("Salary (millions USD)")
```

For each position, the R^2 value is over 0.65 with positive slope. Thus it seems that 2P alone goes pretty far in impacting salary. Let us see if the same holds true for 2P%, the average number of shots made inside the 3-point line divided by the average number of total shots taken inside the 3-point line.

```{r}
# Scatter plot
nbadata %>%
  ggplot(aes(x = `2P%`, y = Salary_dbl)) +
    geom_point(aes(color = Position)) +
    ylab("Salary (millions USD)") + xlab("2P% (avg. # made inside 3-point/avg. # total inside 3-point)")
# Model 2 % by position 
nbadata3 <- nbadata %>%
  group_by(Position) %>%
  #filter(Position %in% c("Forward","Guard")) %>%
  nest()
# Functions for regression frame
fit_model <- function (df) lm(Salary_dbl ~ `2P%`, data = df)
fit_model_aug <- function (df) lm(Salary_dbl ~ `2P%`, data = df) %>% augment()
get_rsq <- function (mod) glance(mod)$r.squared
# Create tidy regression frame
nbadata3 <- nbadata3 %>%
  mutate(model = map(data, fit_model))
nbadata3 <- nbadata3 %>%
  mutate(aug = map(data, fit_model_aug))
nbadata3 <- nbadata3 %>%
  mutate(r.sqradj = map_dbl(model, get_rsq))    # Get R^2
#nbadata3$aug[[1]]
# Plot the regression by position
unnest(nbadata3, aug) %>%
  ggplot() + 
    geom_line(aes(x = `X2P.`, y = .fitted, color = Position)) + 
    geom_point(aes(x = `X2P.`, y = Salary_dbl, color = Position)) +
    ylab("Salary (millions USD)") + xlab("2P% (avg. # made inside 3-point/avg. # total made inside 3-point)")
```

The R^2 values are all less than 0.2, and the lines do not fit the data nearly as well. Thus the average number of shots made per game appears to have a larger impact than the percentage. Three pointers have become more prominent recently; did they have any impact on salary circa 2012?

```{r}
# Scatter plot
nbadata %>%
  ggplot(aes(x = `3P`, y = Salary_dbl)) +
    geom_point(aes(color = Position)) +
    ylab("Salary (millions USD)") + xlab("3P (avg. # shots made from outside 3-point/game)")
# Model 3 by position 
nbadata1 <- nbadata %>%
  group_by(Position) %>%
  filter(Position %in% c("Forward","Guard")) %>%
  nest()
# Functions for regression frame
fit_model <- function (df) lm(Salary_dbl ~ `3P`, data = df)
fit_model_aug <- function (df) lm(Salary_dbl ~ `3P`, data = df) %>% augment()
get_rsq <- function (mod) glance(mod)$r.squared
# Create tidy regression frame
nbadata1 <- nbadata1 %>%
  mutate(model = map(data, fit_model))
nbadata1 <- nbadata1 %>%
  mutate(aug = map(data, fit_model_aug))
nbadata1 <- nbadata1 %>%
  mutate(r.sqradj = map_dbl(model, get_rsq))    # Get R^2
# Plot the regression by position
unnest(nbadata1, aug) %>%
  ggplot() + 
    geom_line(aes(x = `X3P`, y = .fitted, color = Position)) + 
    geom_point(aes(x = `X3P`, y = Salary_dbl, color = Position)) +
    ylab("Salary (millions USD)") + xlab("3P (avg. # shots made from outside 3-point/game)")
```

As we can visually confirm, these shots already appear to be less important for salary. For centers, they do not matter at all. Even for forwards and guards, the R^2 values are less than 0.09 and the slopes are small. Moreover, the p-value for forwards is greater than 0.05. However, it does look like 3-point shots have some impact on the salary of guards, moreso than forwards, as expected. Three pointers do not affect salary very much for this data set. It would be interesting to study more recent data and see if this has changed.

We did not look at how to compute PER--how complex is it? We study this using multiple regression in terms of simpler statistics, with back selection.

```{r}
# Regression with all variables
nba_mod2 <- lm(PER ~ GS + FG + FGA + `FG%` + FT + FTA + `FT%` + `3P` + `2P` + ORB + DRB + TRB + `ORB%` + `DRB%` + AST + `AST%` + STL + `STL%` + BLK + `BLK%` + TOV + `TOV%` + PF + MP, data = nbadata)
# Selection
nba_mod2_step <- stepAIC(nba_mod2, direction = "backward", 
                      trace = FALSE)
nba_mod2_step %>%
  tidy() 
nba_mod2_step %>%
  glance()
# Add and visualize residuals
nbadata <- nbadata %>%
  add_residuals(nba_mod2_step, var = "Mod2Res")
nbadata %>%
  ggplot() +
    geom_histogram(aes(x = `Mod2Res`), binwidth = 1) +
    xlab("Residuals") + ylab("Count")
```

With an R^2 value of 0.96, our model does a great job estimating PER. See also the residual distribution. Thus it seems that PER is little more than a linear combination of simpler statistics.
